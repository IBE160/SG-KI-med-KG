<story-context id="3-3-build-human-in-the-loop-hitl-validation-interface" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>3</storyId>
    <title>Build Human-in-the-Loop (HITL) Validation Interface</title>
    <status>ready-for-dev</status>
    <generatedAt>Friday, December 5, 2025</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/3-3-build-human-in-the-loop-hitl-validation-interface.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Compliance Officer (CO)</asA>
    <iWant>to use the two-stage "AI Review Mode" to efficiently triage AI suggestions and route them for final BPO approval</iWant>
    <soThat>I can act as an effective gatekeeper while ensuring business-level accountability</soThat>
    <tasks>
- Backend: Implement Suggestion Review Endpoints (AC: 2, 3)
  - Create `PATCH /api/v1/suggestions/{id}/status` endpoint.
  - Handle status transitions: `pending` -> `awaiting_bpo_approval` (Accept) or `rejected` (Reject).
  - Allow updating content (`risk_description`, `control_description`) during transition.
  - Implement BPO assignment logic (simple selection for now).
- Backend: Implement Notification Trigger (AC: 3)
  - Create a service method to send notifications (email or in-app).
  - Integrate `fastapi-mail` or just log the event for MVP.
  - Trigger this method upon "Accept" action.
- Frontend: Build AI Review Layout (AC: 1)
  - Create `AIReviewPage` component with a two-column layout (ResizablePanel or Grid).
  - Create `SuggestionList` component with virtualization if many items.
  - Create `SuggestionDetail` component with markdown rendering for rationale.
- Frontend: Implement Review Actions (AC: 2, 4)
  - Add "Accept" and "Reject" buttons to `SuggestionDetail`.
  - Implement API calls to update status.
  - Add "Edit" functionality (switch to input fields).
  - Implement optimistic UI updates (remove item from list immediately).
- Frontend: BPO Selection (AC: 3)
  - Add a User Select dropdown (filtered by BPO role) to the "Accept" flow.
- Testing
  - Unit test: Review endpoint status transitions and validation.
  - Integration test: Full flow of accepting a suggestion and verifying DB state.
  - Component test: Review interface renders correctly and handles actions.
</tasks>
  </story>

  <acceptanceCriteria>
1. Two-pane view: List of suggestions vs Details.
    - The interface presents a split view: a scrollable list of AI-generated suggestions on one side (e.g., left) and the detailed view of the selected suggestion on the other (e.g., right).
    - The list shows summary information (e.g., type, short description, confidence score if available).
    - The detail view shows full content, rationale, and source reference.
2. CO can "Accept" (promote) or "Reject" (dismiss).
    - For each suggestion, the CO has clear actions: "Accept" and "Reject" (or "Dismiss").
    - "Accept" promotes the suggestion to the next stage (BPO review).
    - "Reject" marks the suggestion as rejected and removes it from the active list.
    - The CO can optionally edit the content before accepting.
3. Accepted items trigger notification (mocked or real) for BPO.
    - When a suggestion is accepted, the system assigns it to a BPO (either manually selected by CO or auto-assigned based on metadata).
    - A notification event is triggered for the assigned BPO.
    - The suggestion status updates to "awaiting_bpo_approval".
4. UI updates immediately upon action.
    - The list view updates instantly after an action is taken (optimistic UI or fast re-fetch).
    - The next item in the list is automatically selected.
</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-3.md</path>
        <title>Epic Technical Specification: AI-Powered Gap Analysis &amp; Auditing</title>
        <section>Detailed Design / Workflows and Sequencing</section>
        <snippet>CO Triage workflow: "CO views suggestions -> Selects 'Approve' -> API updates suggestion status -> API creates/links preliminary Risk/Control entity -> API logs audit entry."</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>ibe160 Decision Architecture Document</title>
        <section>6. Novel Pattern Architecture: AI Review Mode</section>
        <snippet>Diagrams and data contracts for "Suggestion Promotion (CO Triage)". Defines `PromoteSuggestionRequest` DTO.</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>backend/app/models/base.py</path>
        <kind>model</kind>
        <symbol>Base</symbol>
        <reason>Base class for SQLAlchemy models.</reason>
      </file>
      <file>
        <path>backend/app/models/suggestion.py</path>
        <kind>model</kind>
        <symbol>AISuggestion</symbol>
        <reason>Data model for AI suggestions (ensure this file exists or is created).</reason>
      </file>
    </code>
    <dependencies>
      <backend>
        <dep>fastapi</dep>
        <dep>pydantic</dep>
        <dep>sqlalchemy</dep>
      </backend>
      <frontend>
        <dep>react-query</dep>
        <dep>lucide-react</dep>
      </frontend>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Use Optimistic UI for the triage list.</constraint>
    <constraint>Use React Query `useMutation` for state updates.</constraint>
    <constraint>Strict state machine for suggestions (no reject -> pending).</constraint>
    <constraint>Mock `fastapi-mail` for MVP notifications if service not configured.</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>Update Suggestion Status</name>
      <kind>REST API</kind>
      <signature>PATCH /api/v1/suggestions/{id}/status</signature>
      <path>backend/app/api/v1/endpoints/suggestions.py</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Unit tests for backend logic. Integration tests for full flow. Component tests for frontend interaction.</standards>
    <locations>backend/tests</locations>
    <ideas>
      <idea ac="2">Test status transition from pending to awaiting_bpo_approval</idea>
      <idea ac="2">Test status transition from pending to rejected</idea>
      <idea ac="2">Test updating content during acceptance</idea>
      <idea ac="3">Verify notification trigger (mocked)</idea>
    </ideas>
  </tests>
</story-context>
