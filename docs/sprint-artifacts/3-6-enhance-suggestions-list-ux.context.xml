<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>6</storyId>
    <title>Enhance Suggestions List UX</title>
    <status>drafted</status>
    <generatedAt>2025-12-13</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/3-6-enhance-suggestions-list-ux.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Compliance Officer (CO)</asA>
    <iWant>the Suggestions list to display BPO assignment information and provide better filtering options</iWant>
    <soThat>I can quickly identify which suggestions are assigned, to whom, and filter suggestions by name/title in addition to type</soThat>
    <tasks>
- Backend: Add BPO User Data to Suggestion Endpoint (AC: 1)
  - Modify GET /api/v1/suggestions endpoint to include BPO user details (name, email) in response
  - Use a JOIN or nested query to fetch assigned_bpo user information if assigned_bpo_id is set
  - Update Pydantic schema to include optional assigned_bpo field with user info

- Frontend: Add "Assigned To" Column (AC: 1)
  - Add new table column in page.tsx after "Source Reference"
  - Display BPO name if assigned, or "Unassigned" text if null
  - Add sorting functionality for the "Assigned To" column
  - Optional: Add tooltip showing BPO role and email on hover

- Frontend: Implement Name/Title Search Filter (AC: 2)
  - Add search input field to the toolbar area (above the table)
  - Implement useState hook for search term
  - Update processedSuggestions memo to filter by name/title using getContentSummary
  - Add clear/reset button (X icon) inside the search input
  - Display active search term as a badge when filtering

- Frontend: Replace Type Filter with Chips (AC: 3)
  - Remove the Select dropdown (lines 186-196 in current page.tsx)
  - Create filter chip/button group: "All", "Risk", "Control", "Business Process"
  - Style active chip with primary color or bold styling
  - Update filterType state on chip click
  - Ensure type and name filters combine correctly in processedSuggestions

- Frontend: Persist Filter State During Session (AC: 4)
  - Verify filter/sort state persists after refetch() (should work with existing useState)
  - Test that filters remain active after reviewing a suggestion

- Testing (AC: 1, 2, 3, 4)
  - Integration test: Fetch suggestions with BPO assignment and verify assigned_bpo data is present
  - Component test: Render "Assigned To" column with various assignment states
  - Component test: Search filter correctly filters by name/title
  - Component test: Type filter chips work and combine with name search
  - Manual test: Verify filter state persists after reviewing a suggestion
</tasks>
  </story>

  <acceptanceCriteria>
1. Add "Assigned To" Column
   - The Suggestions table includes a new "Assigned To" column between "Source Reference" and "Action"
   - For suggestions with assigned_bpo_id set, display the BPO's name (e.g., "Assigned to John Doe")
   - For suggestions without assignment, display "Unassigned" or "Not assigned" in muted text
   - The column is sortable (alphabetically by BPO name or assignment status)
   - Clicking an assigned BPO name optionally shows a tooltip with role and email

2. Enhance Filter UI - Name/Title Search
   - Add a search input field in the toolbar to filter suggestions by name/title
   - The search filters suggestions in real-time as the user types (client-side)
   - The search is case-insensitive and matches partial strings
   - Clear visual indicator when a name filter is active (e.g., "Searching for: [term]" badge)
   - Include a clear/reset button (X icon) in the search input to remove the filter

3. Improve Type Filter Integration
   - Replace the separate "Filter by Type" dropdown (Story 3.5 implementation) with filter chips or tabs
   - Filter chips: "All", "Risk", "Control", "Business Process" displayed as clickable badges/buttons
   - Active filter is visually highlighted (e.g., primary color, bold)
   - Clicking an active chip deselects it and returns to "All"
   - Type and name filters work together (AND logic: show only items matching BOTH filters)

4. Filter State Persistence
   - Filter and sort state persists during the session (survives refetch after reviewing a suggestion)
   - State resets when navigating away from the page
   - URL query parameters are NOT required (session-only state is acceptable)
</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-3.md</path>
        <title>Epic Technical Specification: AI-Powered Gap Analysis &amp; Auditing</title>
        <section>Detailed Design > Review UI</section>
        <snippet>Implement name/title search filter with real-time filtering. Replace type filter dropdown with integrated filter chips/tabs. Add "Assigned To" column displaying BPO assignment status and name.</snippet>
      </doc>
      <doc>
        <path>docs/ux-design-specification.md</path>
        <title>UX Design Specification</title>
        <section>Component Library > Standard Components</section>
        <snippet>Leverage Shadcn/UI for buttons, form elements, and data display. Filter chips pattern using Badge or Button components.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/3-5-enhance-ai-review-capabilities.md</path>
        <title>Story 3.5: Enhance AI Review Capabilities</title>
        <section>Dev Notes > Learnings</section>
        <snippet>Story 3.6 will replace the filter dropdown (lines 186-196 in page.tsx) with chips. The processedSuggestions useMemo pattern works well and should be extended.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>backend/app/api/v1/endpoints/suggestions.py</path>
        <kind>controller</kind>
        <symbol>read_suggestions</symbol>
        <reason>Endpoint to modify to include BPO user details in response (JOIN with User table).</reason>
      </artifact>
      <artifact>
        <path>backend/app/schemas/suggestion.py</path>
        <kind>schema</kind>
        <symbol>Suggestion</symbol>
        <reason>Add 'assigned_bpo' field (UserRead schema) to the response model.</reason>
      </artifact>
      <artifact>
        <path>frontend/app/dashboard/admin/suggestions/page.tsx</path>
        <kind>component</kind>
        <symbol>SuggestionList</symbol>
        <reason>Main component to modify: Add column, Add Search Input, Replace Dropdown with Chips.</reason>
      </artifact>
      <artifact>
        <path>frontend/components/ui/input.tsx</path>
        <kind>component</kind>
        <symbol>Input</symbol>
        <reason>Reusable component for the search input field.</reason>
      </artifact>
    </code>
    <dependencies>
      <dependency>frontend: lucide-react (Icons for search/clear)</dependency>
      <dependency>frontend: shadcn/ui (Badge/Button for chips)</dependency>
      <dependency>backend: sqlalchemy (Joined loading for BPO)</dependency>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Filter state persistence must be session-based (React state), surviving refetch but resetting on navigation.</constraint>
    <constraint>Search must be real-time and client-side on the fetched dataset.</constraint>
    <constraint>Type and Name filters must use AND logic (show intersection).</constraint>
    <constraint>Use Shadcn/UI components for visual consistency.</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>GET /api/v1/suggestions</name>
      <kind>REST Endpoint</kind>
      <signature>Response: List[Suggestion] (Extended with assigned_bpo: Optional[UserRead])</signature>
      <path>backend/app/api/v1/endpoints/suggestions.py</path>
    </interface>
    <interface>
      <name>Suggestion Schema</name>
      <kind>Pydantic Model</kind>
      <signature>assigned_bpo: Optional[UserRead]</signature>
      <path>backend/app/schemas/suggestion.py</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Use Pytest for backend integration tests (mocking DB/Auth). Use React Testing Library/Playwright for frontend component interactions.</standards>
    <locations>
      <location>backend/tests/api/v1/test_suggestions.py</location>
      <location>frontend/__tests__/dashboard/admin/suggestions.test.tsx</location>
    </locations>
    <ideas>
      <idea>Verify "Assigned To" column shows correct name or "Unassigned".</idea>
      <idea>Test partial string match for name search (case-insensitive).</idea>
      <idea>Test filter chips selection/deselection and visual state.</idea>
      <idea>Test combined filtering (Type + Search).</idea>
    </ideas>
  </tests>
</story-context>