<story-context id="template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>1</storyId>
    <title>Implement User Registration &amp; Login (Email/Password)</title>
    <status>drafted</status>
    <generatedAt>2025-12-05</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/2-1-implement-user-registration-login-email-password.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>new user</asA>
    <iWant>to securely register for an account and log in using email and password</iWant>
    <soThat>I can access the application's features as an authenticated user</soThat>
    <tasks>
- [ ] **Configure Supabase Auth for Email/Password** (AC: #2, #3, #4)
  - [ ] Verify Supabase project settings enable email/password authentication
  - [ ] Configure email templates for verification and password reset
  - [ ] Set password complexity requirements (min 8 chars, complexity rules)
  - [ ] Configure SendGrid integration for transactional emails

- [ ] **Implement Backend Authentication Integration** (AC: #2, #5)
  - [ ] Review and update `backend/app/core/security.py` for Supabase JWT validation
  - [ ] Implement middleware to extract and validate JWT tokens from Authorization header
  - [ ] Create user profile model with `tenant_id` and `role` fields
  - [ ] Implement default role assignment logic (General User) on registration

- [ ] **Build Registration UI** (AC: #1, #2, #3)
  - [ ] Create registration page at `frontend/app/(auth)/register/page.tsx`
  - [ ] Build registration form with email and password fields using React Hook Form
  - [ ] Implement client-side password validation (complexity requirements)
  - [ ] Add Zod schema validation for form inputs
  - [ ] Integrate Supabase client `signUp` method
  - [ ] Display email verification prompt after successful registration
  - [ ] Handle and display registration errors (duplicate email, weak password, etc.)

- [ ] **Build Login UI** (AC: #4)
  - [ ] Create login page at `frontend/app/(auth)/login/page.tsx`
  - [ ] Build login form with email and password fields
  - [ ] Integrate Supabase client `signInWithPassword` method
  - [ ] Store JWT token in HTTP-only cookie or secure session storage
  - [ ] Redirect authenticated users to dashboard
  - [ ] Handle and display login errors (invalid credentials, unverified email, etc.)

- [ ] **Implement Password Reset Flow** (Out of scope for MVP, noted for future)
  - [ ] Create "Forgot Password" link on login page
  - [ ] Implement password reset request flow
  - [ ] Create password reset confirmation page

- [ ] **Write Integration Tests** (AC: #2, #3, #4, #5)
  - [ ] Write backend test for user registration and role assignment
  - [ ] Write backend test for JWT validation middleware
  - [ ] Write Playwright E2E test for registration flow (form submission, email sent)
  - [ ] Write Playwright E2E test for email verification flow (requires test email service)
  - [ ] Write Playwright E2E test for login flow (successful and failed attempts)
  - [ ] Write Playwright E2E test for authenticated route protection
</tasks>
  </story>

  <acceptanceCriteria>
1. **Given** I am on the registration page,
2. **When** I provide a valid email and password (meeting complexity requirements),
3. **Then** my account is created, and I receive an email verification link.
4. **And** after verifying my email, I can log in successfully.
5. **And** upon login, I am assigned the "General User" role by default within a tenant.
</acceptanceCriteria>

  <artifacts>
    <docs>
      <!-- PRD Artifacts -->
      <artifact>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>FR-1: Role-Based Access Control</section>
        <snippet>The system must support role-based access control (RBAC). Roles include: Admin, General User, Risk Manager. Authentication is required for all access except public pages.</snippet>
      </artifact>
      
      <!-- Tech Spec Artifacts -->
      <artifact>
        <path>docs/tech-spec-epic-2.md</path>
        <title>Technical Specification - Epic 2</title>
        <section>Authentication Architecture</section>
        <snippet>Use Supabase Auth as the identity provider. Backend validates JWTs using Supabase public keys. Frontend uses Supabase JS client for login/register flows. Tokens stored in secure HTTP-only cookies.</snippet>
      </artifact>

      <!-- Architecture Artifacts -->
      <artifact>
        <path>docs/architecture.md</path>
        <title>System Architecture</title>
        <section>4.2 Deployment Targets</section>
        <snippet>Frontend: Next.js on Vercel. Backend: Python FastAPI on Render/Vercel. Database: PostgreSQL (Supabase). Auth: Supabase Auth.</snippet>
      </artifact>

      <!-- UX Design Artifacts -->
      <artifact>
        <path>docs/ux-design-specification.md</path>
        <title>UX Design Specification</title>
        <section>Authentication Flows</section>
        <snippet>Login page should be simple, centered card layout. Registration requires email, password, confirm password. Verification email sent immediately. Error messages should be inline and descriptive.</snippet>
      </artifact>
    </docs>

    <code>
      <!-- Existing Security Code -->
      <artifact>
        <path>backend/app/core/security.py</path>
        <kind>file</kind>
        <symbol>security</symbol>
        <reason>Existing security module. Needs update for Supabase JWT validation.</reason>
      </artifact>

      <!-- Frontend Supabase Client -->
      <artifact>
        <path>frontend/lib/supabase.ts</path>
        <kind>file</kind>
        <symbol>createClient</symbol>
        <reason>Supabase client instance configuration.</reason>
      </artifact>

      <!-- Frontend Middleware -->
      <artifact>
        <path>frontend/middleware.ts</path>
        <kind>file</kind>
        <symbol>middleware</symbol>
        <reason>Next.js middleware for route protection. Needs to handle auth state.</reason>
      </artifact>

       <!-- Frontend Auth Components -->
      <artifact>
        <path>frontend/components/ui/form.tsx</path>
        <kind>component</kind>
        <symbol>Form</symbol>
        <reason>Shadcn UI form components for building login/register forms.</reason>
      </artifact>
    </code>

    <dependencies>
      <dependency ecosystem="npm">
        <package>@supabase/supabase-js</package>
        <version>latest</version>
      </dependency>
      <dependency ecosystem="npm">
        <package>@supabase/ssr</package>
        <version>latest</version>
      </dependency>
      <dependency ecosystem="npm">
        <package>zod</package>
        <version>latest</version>
      </dependency>
      <dependency ecosystem="npm">
        <package>react-hook-form</package>
        <version>latest</version>
      </dependency>
       <dependency ecosystem="python">
        <package>supabase</package>
        <version>latest</version>
      </dependency>
      <dependency ecosystem="python">
        <package>python-jose</package>
        <version>latest</version>
      </dependency>
       <dependency ecosystem="python">
        <package>passlib</package>
        <version>latest</version>
      </dependency>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Use Supabase Auth as the single source of truth for identity.</constraint>
    <constraint>Do NOT store passwords in local database; store only user profile refs linked by UUID.</constraint>
    <constraint>JWT tokens must be validated on every protected backend request.</constraint>
    <constraint>Frontend must use server-side auth helpers (@supabase/ssr) for cookie management.</constraint>
    <constraint>Password complexity: Min 8 chars, 1 upper, 1 lower, 1 number, 1 symbol.</constraint>
    <constraint>All auth pages must be responsive and accessible (WCAG 2.1 AA).</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>Supabase SignUp</name>
      <kind>Function</kind>
      <signature>supabase.auth.signUp({ email, password })</signature>
      <path>frontend/lib/supabase.ts</path>
    </interface>
    <interface>
      <name>Supabase SignIn</name>
      <kind>Function</kind>
      <signature>supabase.auth.signInWithPassword({ email, password })</signature>
      <path>frontend/lib/supabase.ts</path>
    </interface>
    <interface>
      <name>JWT Validation Middleware</name>
      <kind>Middleware</kind>
      <signature>get_current_user(token: str)</signature>
      <path>backend/app/core/security.py</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Frontend: Playwright for E2E auth flows (login, register). Jest/React Testing Library for form validation unit tests.
      Backend: Pytest for JWT validation logic and user profile creation.
    </standards>
    <locations>
      <location>frontend/tests/e2e/auth.spec.ts</location>
      <location>backend/tests/api/test_auth.py</location>
    </locations>
    <ideas>
      <idea ac="1">Test that registration page loads with all fields.</idea>
      <idea ac="2">Test registration with valid data triggers email.</idea>
      <idea ac="2">Test registration with weak password fails validation.</idea>
      <idea ac="2">Test registration with existing email shows error.</idea>
      <idea ac="4">Test login with verified email succeeds.</idea>
      <idea ac="4">Test login with unverified email fails (if enforced).</idea>
      <idea ac="4">Test login with invalid password fails.</idea>
      <idea ac="5">Test that new user has "General User" role in token/profile.</idea>
    </ideas>
  </tests>
</story-context>
